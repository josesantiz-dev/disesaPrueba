<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a4j="http://richfaces.org/a4j" 
    xmlns:rich="http://richfaces.org/rich">

	<rich:popupPanel id="pnlCapturarFacturas" autosized="true" modal="true" domElementAttachment="form" top="20" style="width:100%;"
    	header="#{msg['capturar']} #{msg['facturas']}">
		
		<f:facet name="controls">
			<h:graphicImage style="cursor:pointer;" 
				value="#{msg['navegacion.panel.cerrar.img']}" 
				onclick="#{rich:component('pnlCapturarFacturas')}.hide()" />
		</f:facet>
		<div class="div_titulo" style="margin:50px auto 0;">
			<h:outputText value="#{subcontratistaAction.nombreSubContratista}" style="font-weight:bold; font-size:28px; color:#525252;"/>
		</div>
		<h:panelGrid columns="2" columnClasses="colLayoutBottom,colLayoutBottom" cellpadding="0" cellspacing="0" style="margin:10px auto; display:block;">
			<h:panelGroup layout="block" style="width:100%;">
				<h:panelGrid columns="2" columnClasses="colPnlBusqIzq" style="margin:0 auto;">
					<h:outputText value="#{msg['obra']}:" styleClass="Titulo" />
					<h:outputText value="#{subcontratistaAction.obra}" styleClass="Titulo" style="text-align:left; display:block;" />
								
					<h:outputText value="#{msg['cliente']}:" styleClass="Titulo" />
					<h:outputText styleClass="Titulo" style="text-align:left; display:block;" 
							value="#{subcontratistaAction.cliente}" />
		
				</h:panelGrid>
			</h:panelGroup>
			<h:panelGroup layout="block" style="width:100%;">
								
				<h:panelGroup id="groupBotonesFacturas" layout="block" style="display:inline-block; position:absolute; right:0; text-align:right; margin:-28px 50px 0; min-width:98px; min-height:28px; z-index:1;">
							
					<a4j:commandButton id="cmdReporte" style="margin:auto 5px; vertical-align:middle; cursor:pointer;" 
						rendered="#{subcontratistaAction.obra ne ''}"
						image="#{msg['imprimir22.img']}" title="#{msg['imprimir.e']} #{msg['estadoCuenta']} #{msg['cobranza']}"
						action="#{subcontratistaAction.reporte}" 
						oncomplete="reporte(#{subcontratistaAction.band}, '#{rich:clientId('pnlMensajes')}')"
						render="pnlMensajes" limitRender="true" />
								
					<a4j:commandButton id="cmdFacturaNuevo" style="margin:auto 5px; vertical-align:middle; cursor:pointer;" 
						rendered="#{subcontratistaAction.obra ne ''}"
						image="#{msg['nuevo22.img']}" title="#{msg['nuevo.e']}"
						action="#{subcontratistaAction.nuevo}" execute="@region" 
						oncomplete="buscar(#{subcontratistaAction.band}, '#{rich:clientId('pnlMensajes')}')"
						render="dtCapturarFacturas" limitRender="true" />
							
					<a4j:commandButton id="cmdFacturaActualizar" style="margin:auto 5px; vertical-align:middle; cursor:pointer;"
						rendered="#{subcontratistaAction.obra ne ''}"
						image="#{msg['actualizar22.img']}" title="#{msg['actualizar']}" 
						action="#{subcontratistaAction.ver}" execute="@region" 
						render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
				</h:panelGroup>
			</h:panelGroup>
		</h:panelGrid> 
							
		<a4j:region id="regCapturarFacturas">
				<rich:dataTable id="dtCapturarFacturas" value="#{subcontratistaAction.listFacturaSubcontratistas}" var="var" iterationStatusVar="it" rows="100" 
					cellpadding="0" cellspacing="0" border="0" rowClasses="Row2" styleClass="tabla_pagina" style="width:100%; margin:0 0 30px;">
					<f:facet name="header">
						<rich:columnGroup>
							<rich:column styleClass="Titulo" style="text-align:center; padding:auto 2px;" colspan="15">
								<h:outputLabel value="#{msg['subcontratista']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:auto 2px;" colspan="3">
								<h:outputLabel value="#{msg['factura']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:auto 2px;" colspan="2" rowspan="2">
								<a4j:commandButton id="cmdSubcontratistaGuardarTodo" style="margin:auto 5px; vertical-align:middle; cursor:pointer;" 
									rendered="#{subcontratistaAction.guardarTodo}"
									image="#{msg['salvar22.img']}" title="#{msg['salvar.e']} #{msg['todo']}"
									action="#{subcontratistaAction.guardarTodo}" execute="@region" 
									oncomplete="buscar(#{subcontratistaAction.band}, '#{rich:clientId('pnlMensajes')}')"
									render="pnlMensajes,groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:20px;" breakRowBefore="true">
								<h:outputLabel value="#" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['tipo']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:70px;">
								<h:outputLabel value="#{msg['fecha']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['descripcion']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:60px;">
								<h:outputLabel value="#{msg['porcentaje']} #{msg['anticipo']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:60px;">
								<h:outputLabel value="#{msg['porcentaje']} #{msg['retencion']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:70px;">
								<h:outputText value="#{msg['anticipo']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:70px;">
								<h:outputLabel value="#{msg['estimacion']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:90px;">
								<h:outputLabel value="#{msg['amortizacion']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:90px;">
								<h:outputLabel value="#{msg['fondo']} #{msg['garantia']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:90px;">
								<h:outputLabel value="#{msg['pago']} #{msg['fondo']} #{msg['garantia']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['subtotal']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['impuestos']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px; width:90px;">
								<h:outputLabel value="#{msg['cargos']}" title="#{msg['cargos']} #{msg['subcontratista']} #{msg['con']} #{msg['iva']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['total']}" title="#{msg['total']}: (#{msg['estimacion']} - #{msg['amortizacion']} - #{msg['fondo']} #{msg['garantia']})" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['factura']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['concepto']}" />
							</rich:column>
							
							<rich:column styleClass="Titulo" style="text-align:center; padding:2px;">
								<h:outputLabel value="#{msg['facturado']}" />
							</rich:column>
						</rich:columnGroup>
					</f:facet>
			        
					<rich:column style="text-align:center;">
						<h:outputLabel value="#{it.index + 1}" title="#{msg['registro']}: #{var.id}"><f:convertNumber pattern="00" /></h:outputLabel>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<rich:select value="#{var.tipoSubClave}">
							<f:selectItem itemLabel="#{msg['seleccione']}" />
							<f:selectItems value="#{subcontratistaAction.listTipoSubItems}" />
							<a4j:ajax event="change" execute="@region" listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
						</rich:select>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<rich:calendar datePattern="dd-MMM-yyyy" inputSize="4" enableManualInput="false" 
							value="#{var.fecha}" disabled="#{var.nuevo eq false}" />
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:95%; text-align:left; font-size:0.95em;"
							value="#{var.descripcion}">
							<a4j:ajax event="blur" execute="@region"
								render="@this" limitRender="true" />
						</h:inputText>
					</rich:column> 
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:48px; text-align:right; font-size:0.95em;"
							value="#{var.porcentajeAnticipo}" 
							onkeypress="return soloDecimales(event, this.value, 3, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.porcentajeFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcularPorcentaje}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column> 
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:48px; text-align:right; font-size:0.95em;"
							value="#{var.porcentajeRetencion}" 
							onkeypress="return soloDecimales(event, this.value, 3, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.porcentajeFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcularPorcentaje}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column> 
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.anticipo}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.estimacion}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.amortizacion}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.fondoGarantia}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.pagoFondoGarantia}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:right;">
						<h:outputLabel value="#{var.subtotal}"><f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" /></h:outputLabel>
					</rich:column>
					
					<rich:column style="text-align:right;">
						<h:outputLabel value="#{var.totalImpuestos}"><f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" /></h:outputLabel>
						<a4j:commandLink id="cmdDesgloseImpuestos" style="display:block; margin:2px auto 0; cursor:pointer;" 
							value="#{msg['desglose']}" rendered="#{var.totalImpuestos > 0}"
							action="#{subcontratistaAction.desgloseImpuestos}"
							oncomplete="verEditar(#{subcontratistaAction.band}, '#{rich:clientId('pnlDesgloseImpuestos')}', '#{rich:clientId('pnlMensajes')}')"
							render="pnlDesgloseImpuestos,pnlMensajes" limitRender="true">
							<f:setPropertyActionListener for="cmdDesgloseImpuestos" value="#{it.index}" target="#{subcontratistaAction.indexFactura}" />
						</a4j:commandLink>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<h:inputText style="width:72px; text-align:right; font-size:0.95em;"
							value="#{var.cargos}" 
							onkeypress="return soloDecimales(event, this.value, 10, 4);">
							<f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" />
							<f:attribute name="targetIndex" value="#{it.index}" /> 
							<a4j:ajax event="blur" execute="@region"
								listener="#{subcontratistaAction.recalcular}" 
								render="groupPorcentajesGlobales,groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true" />
						</h:inputText>
					</rich:column>
					
					<rich:column style="text-align:right;">
						<h:outputLabel value="#{var.total}"><f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" /></h:outputLabel>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<a4j:commandLink id="cmdCargarXML" 
							value="#{var.folioFactura} #{var.folioFactura eq '' ? msg['cargar'] : ''}" title="#{(var.folioFactura eq '' ? msg['cargar'] : msg['cambiar'])} #{msg['factura']}"
							action="#{subcontratistaAction.nuevaCarga}"
							oncomplete="verEditar(#{subcontratistaAction.band}, '#{rich:clientId('pnlCargarXML')}', '#{rich:clientId('pnlMensajes')}')"
							render="pnlCargarXML,pnlMensajes" limitRender="true">
							<f:setPropertyActionListener for="cmdCargarXML" value="#{it.index}" target="#{subcontratistaAction.indexFactura}" />
						</a4j:commandLink>
					</rich:column>
					
					<rich:column style="text-align:left;">
						<h:outputLabel value="#{var.concepto}" title="#{msg['concepto']}: #{var.idConcepto} - #{var.concepto}" 
							style="display:inline-block; width:100%; height:100%; max-height:72px; font-size:0.9em; overflow:hidden; text-overflow:ellipsis; text-align:left; text-transform:uppercase;" />
					</rich:column>
					
					<rich:column style="text-align:right;">
						<h:outputLabel value="#{var.facturaTotal}"><f:convertNumber pattern="#{subcontratistaAction.decimalFormat}" /></h:outputLabel>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<a4j:commandButton id="cmdGuardar" rendered="#{var.guardable}"
							image="#{msg['salvar16.img']}" title="#{msg['salvar.e']}" 
							action="#{subcontratistaAction.guardar}"
							render="groupBotonesFacturas,cmdSubcontratistaGuardarTodo,dtCapturarFacturas" limitRender="true">
							<f:setPropertyActionListener for="cmdGuardar" value="#{it.index}" target="#{subcontratistaAction.indexFactura}" />
						</a4j:commandButton>
					</rich:column>
					
					<rich:column style="text-align:center;">
						<a4j:commandButton id="cmdEliminarFactura" 
							image="#{msg['eliminar16.img']}" title="#{msg['eliminar']}"
							oncomplete="#{rich:component('pnlEliminarFactura')}.show()" 
							render="pnlEliminar" limitRender="true">
							<f:setPropertyActionListener for="cmdEliminarFactura" value="#{it.index}" target="#{subcontratistaAction.indexFactura}" />
						</a4j:commandButton>
					</rich:column>
					
					<f:facet name="footer">
						<rich:dataScroller for="dtCapturarFacturas" page="#{subcontratistaAction.paginacionCobranza}" renderIfSinglePage="false"
							ajaxSingle="true" maxPages="10" fastStep="10" align="center" styleClass="Titulo" />
					</f:facet>
				</rich:dataTable>
			</a4j:region>
	</rich:popupPanel>
</ui:composition>